machine:
  environment:
    COUNT_INTEGRATION_COVERAGE: 'true'

dependencies:
  cache_directories:
    - "luchador/env/ale/rom"
    - "Arcade-Learning-Environment"
  pre:
    - sudo apt-get update
    - git fetch --unshallow origin || true
    - ./cci_script/install_dependencies.sh
    - ./cci_script/fix_urllib_sni.sh
  override:
    - ./cci_script/install_ale.sh
    - ./cci_script/download_atari_roms.sh luchador/env/ale/rom
    - pip install --upgrade numpy
    - pip install --upgrade scipy
    - pip install --upgrade git+git://github.com/Theano/Theano.git
    - pip install --upgrade https://storage.googleapis.com/tensorflow/linux/cpu/tensorflow-0.12.1-cp27-none-linux_x86_64.whl
    # Install luchador in editable mode so that coverage.py can collect data in integration tests
    - pip install --upgrade -e .
  post:
    - sudo apt-get autoremove
    - ./cci_script/print_version.sh

test:
  pre:
    - pip install --upgrade flake8
    - pip install --upgrade coverage
    - coverage erase && rm -rf .coverage.*
    - mkdir -p tmp
  override:
    # Unit tests
    - LUCHADOR_NN_BACKEND=theano     LUCHADOR_NN_CONV_FORMAT=NCHW coverage run --parallel-mode setup.py test
    - LUCHADOR_NN_BACKEND=tensorflow LUCHADOR_NN_CONV_FORMAT=NHWC coverage run --parallel-mode setup.py test
    # Integration tests
    - ./tests/integration/run_serialization_tests.sh
    - ./tests/integration/run_initializer_compatibility_test.sh
    - ./tests/integration/run_layer_numerical_compatibility_tests.sh
    - ./tests/integration/run_optimizer_numerical_compatibility_tests.sh
    - ./tests/integration/test_server_client/run_server_client.sh
    - ./tests/integration/test_server_client/run_manager_server.sh
    - ./tests/integration/run_envs.sh
    - LUCHADOR_NN_BACKEND=theano     LUCHADOR_NN_CONV_FORMAT=NCHW ./tests/integration/run_dqn.sh
    - LUCHADOR_NN_BACKEND=tensorflow LUCHADOR_NN_CONV_FORMAT=NHWC ./tests/integration/run_dqn.sh
    # Style check
    - flake8 luchador
    - flake8 tests
  post:
    # Report test coverage
    - if [[ "$CIRCLE_PROJECT_USERNAME" -eq "mthrok" ]]; then ./cci_script/report_codacy_test_coverage.sh; fi

deployment:
   docs:
     branch: master
     owner: mthrok
     commands:
       - pip install Sphinx numpydoc sphinx_rtd_theme
       - ./cci_script/build_docs.sh
